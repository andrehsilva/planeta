{% extends "dashboard/dashboard_base.html" %}

{% block dashboard_content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Gerenciar Leads</h1>
    <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
        <span class="inline-flex items-center rounded-md bg-blue-100 px-3 py-2 text-sm font-medium text-blue-800">
            Total de Leads: {{ leads_pagination.total }}
        </span>
    </div>
</div>

<div class="bg-white p-6 rounded-lg shadow-md">
    <form method="GET" action="{{ url_for('dashboard.leads') }}" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 pb-6 border-b">
        <div>
            <label for="search" class="block text-sm font-medium text-gray-700">Buscar por Nome</label>
            <input type="text" name="search" id="search" value="{{ filters.search or '' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nome do lead ou responsável...">
        </div>
        <div>
            <label for="status" class="block text-sm font-medium text-gray-700">Filtrar por Status</label>
            <select id="status" name="status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option value="" {% if not filters.status %}selected{% endif %}>Todos os Status</option>
                {% for status in all_statuses %}
                    <option value="{{ status }}" {% if filters.status == status %}selected{% endif %}>{{ status }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex items-end space-x-2">
            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Filtrar</button>
            <a href="{{ url_for('dashboard.leads') }}" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Limpar</a>
        </div>
    </form>
    
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">Data</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Responsável</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Contato</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Status</th>
                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">Ações</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for lead in leads_pagination.items %}
                <tr>
                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-gray-500 sm:pl-6">{{ lead.created_at.strftime('%d/%m/%y %H:%M') }}</td>
                    <td class="px-3 py-4 whitespace-nowrap">
                        <div class="font-medium text-gray-900">{{ lead.parent_name }}</div>
                        {% if lead.child_name %}<div class="text-sm text-gray-500">Criança: {{ lead.child_name }}</div>{% endif %}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        <p>{{ lead.email }}</p>
                        <p class="font-medium text-gray-700">{{ lead.whatsapp }}</p>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if lead.status == 'Novo' %}
                            <span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">Novo</span>
                        {% elif lead.status == 'Contactado' %}
                            <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">Contactado</span>
                        {% elif lead.status == 'Não Atendeu' %}
                            <span class="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">Não Atendeu</span>
                        {% elif lead.status == 'Reagendar' %}
                            <span class="inline-flex items-center rounded-full bg-purple-100 px-2.5 py-0.5 text-xs font-medium text-purple-800">Reagendar</span>
                        {% elif lead.status == 'Descartado' %}
                            <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">Descartado</span>
                        {% else %}
                            <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-800">{{ lead.status }}</span>
                        {% endif %}
                    </td>
                    <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                        <div class="flex items-center justify-end space-x-4">
                            <form method="POST" action="{{ url_for('dashboard.update_lead_status', lead_id=lead.id) }}" class="flex items-center space-x-2">
                                <select name="status" class="block w-full rounded-md border-gray-300 py-1 pl-3 pr-8 text-xs focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                                    <option value="Novo" {% if lead.status == 'Novo' %}selected{% endif %}>Novo</option>
                                    <option value="Contactado" {% if lead.status == 'Contactado' %}selected{% endif %}>Contactado</option>
                                    <option value="Não Atendeu" {% if lead.status == 'Não Atendeu' %}selected{% endif %}>Não Atendeu</option>
                                    <option value="Reagendar" {% if lead.status == 'Reagendar' %}selected{% endif %}>Reagendar</option>
                                    <option value="Descartado" {% if lead.status == 'Descartado' %}selected{% endif %}>Descartado</option>
                                </select>
                                <button type="submit" class="text-indigo-600 hover:text-indigo-900" title="Salvar Status">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                                </button>
                            </form>
                            <a href="{{ url_for('dashboard.send_lead_message', lead_id=lead.id) }}" target="_blank" class="text-green-600 hover:text-green-900" title="Enviar Mensagem Padrão">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-0.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="px-6 py-10 text-center text-gray-500">Nenhum lead encontrado com os filtros aplicados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if leads_pagination and leads_pagination.pages > 1 %}
        {% with pagination=leads_pagination %}
            {% include 'dashboard/_pagination.html' %}
        {% endwith %}
    {% endif %}
</div>
{% endblock %}