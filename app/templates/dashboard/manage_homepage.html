{% extends "dashboard/dashboard_base.html" %}
{% from "macros/_form_helpers.html" import render_field %}

{% block dashboard_content %}
<h1 class="text-3xl font-bold text-gray-800 mb-6">{{ title }}</h1>

<div class="bg-white p-4 md:p-8 rounded-lg shadow-md max-w-4xl mx-auto">
    <form method="POST" enctype="multipart/form-data" novalidate>
        {{ form.hidden_tag() }}

        <div x-data="{ openSection: 'order' }" class="space-y-4">

            <div class="border border-gray-200 rounded-lg">
                <h2 @click="openSection = (openSection === 'order' ? '' : 'order')" class="p-4 font-semibold text-lg cursor-pointer flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors rounded-lg">
                    <span>Ordem das Seções</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform" :class="{ 'rotate-180': openSection === 'order' }" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </h2>
                <div x-show="openSection === 'order'" x-transition class="p-4 border-t border-gray-200">
                    <input type="hidden" name="section_order" id="section_order_input" value="{{ content.section_order }}">
                    <p class="text-sm text-gray-500 mb-4">Arraste e solte os itens para reordenar as seções na sua página inicial.</p>
                    {% set section_names = {
                        'hero': 'Hero (Topo da Página)',
                        'services': 'O que oferecemos',
                        'values': 'Por que nos escolher',
                        'structure': 'Infraestrutura',
                        'blog': 'Diário de bordo (Blog)',
                        'cta': 'CTA Final',
                        'location': 'Localização'
                    } %}
                    <ul id="sortable-sections" class="space-y-2">
                        {% for section_key in ordered_sections_admin %}
                        <li data-section-name="{{ section_key }}" class="p-4 bg-white border rounded-md cursor-move flex items-center hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                            <span class="font-medium text-gray-700">{{ section_names.get(section_key, section_key) }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            {% set sections = {
                'Hero (Topo da Página)': { 'key': 'hero', 'description': 'Controla a visibilidade e o conteúdo da primeira seção do site.', 'toggle_field': 'show_hero_section', 'fields': ['hero_background_color_from', 'hero_background_color_to', 'hero_badge_text', 'hero_title', 'hero_subtitle', 'hero_whatsapp_button_text', 'hero_whatsapp_button_link', 'hero_highlight_text'] },
                'Seção "O que oferecemos"': { 'key': 'services', 'description': 'Controla a seção que apresenta os principais serviços nos 3 cards.', 'toggle_field': 'show_services_section', 'fields': ['services_section_tagline', 'services_section_title', 'services_section_subtitle', 'services_card1_icon', 'services_card1_title', 'services_card1_text', 'services_card1_item1', 'services_card1_item2', 'services_card1_item3', 'services_card1_cta_text', 'services_card1_cta_link', 'services_card2_icon', 'services_card2_title', 'services_card2_text', 'services_card2_item1', 'services_card2_item2', 'services_card2_item3', 'services_card2_cta_text', 'services_card2_cta_link', 'services_card3_icon', 'services_card3_title', 'services_card3_text', 'services_card3_item1', 'services_card3_item2', 'services_card3_item3', 'services_card3_cta_text', 'services_card3_cta_link'] },
                'Seção "Por que nos escolher"': { 'key': 'values', 'description': 'Controla a seção que mostra os diferenciais e valores da empresa.', 'toggle_field': 'show_values_section', 'fields': ['values_section_tagline', 'values_section_title', 'values_section_subtitle', 'values_card1_icon', 'values_card1_title', 'values_card1_text', 'values_card2_icon', 'values_card2_title', 'values_card2_text', 'values_card3_icon', 'values_card3_title', 'values_card3_text'] },
                'Seção "Infraestrutura"': { 'key': 'structure', 'description': 'Controla a seção com a descrição do espaço físico e a galeria de fotos.', 'toggle_field': 'show_structure_section', 'fields': ['structure_section_tagline', 'structure_section_title', 'structure_section_subtitle', 'structure_feature1_title', 'structure_feature1_text', 'structure_feature2_title', 'structure_feature2_text'] },
                'Seção "Diário de bordo" (Blog)': { 'key': 'blog', 'description': 'Controla a seção que exibe as últimas postagens do blog.', 'toggle_field': 'show_blog_section', 'fields': ['blog_section_tagline', 'blog_section_title', 'blog_section_subtitle', 'blog_cta_text'] },
                'Seção CTA Final': { 'key': 'cta', 'description': 'Controla a seção de chamada para ação (Call to Action) no final da página.', 'toggle_field': 'show_cta_section', 'fields': ['cta_title', 'cta_subtitle', 'cta_whatsapp_button_text', 'cta_form_button_text'] },
                'Seção "Localização"': { 'key': 'location', 'description': 'Controla a seção final com informações de endereço, contato e mapa.', 'toggle_field': 'show_location_section', 'fields': ['location_section_tagline', 'location_section_title', 'location_section_subtitle', 'location_card_title', 'location_address_title', 'location_address_text', 'location_phone_title', 'location_phone_text', 'location_hours_title', 'location_hours_text', 'location_gmaps_button_text', 'location_gmaps_link', 'location_image_alt'] }
            } %}

            {% for title, section in sections.items() %}
            <div class="border border-gray-200 rounded-lg">
                <h2 @click="openSection = (openSection === '{{ section.key }}' ? '' : '{{ section.key }}')" class="p-4 font-semibold text-lg cursor-pointer flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors rounded-lg">
                    <span>{{ title }}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform" :class="{ 'rotate-180': openSection === '{{ section.key }}' }" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </h2>
                <div x-show="openSection === '{{ section.key }}'" x-transition class="p-6 border-t border-gray-200">
                    <fieldset>
                        {% if section.toggle_field and form[section.toggle_field] %}
                            <div class="bg-slate-100 p-4 rounded-md mb-6 border border-slate-200">
                                <div class="flex items-center">
                                    {{ form[section.toggle_field](class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500") }}
                                    <label for="{{ form[section.toggle_field].id }}" class="ml-3 block text-sm font-medium text-gray-900">
                                        {{ form[section.toggle_field].label.text }}
                                    </label>
                                </div>
                            </div>
                        {% endif %}

                        <div class="space-y-4">
                            {% for field_name in section.fields %}
                                {% if form[field_name] %}
                                    {{ render_field(form[field_name], rows=3) }}
                                {% endif %}
                            {% endfor %}
                        </div>

                        {% if section.key == 'structure' %}
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            
                            <div class="mt-4">
                                <label for="{{ form.gallery_images.id }}" class="block text-sm font-medium text-gray-700">
                                    {{ form.gallery_images.label.text }}
                                </label>
                                <div class="mt-1">
                                    {{ form.gallery_images(class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none", multiple="multiple") }}
                                    {% if form.gallery_images.errors %}
                                        <ul class="text-sm text-red-600 mt-1">
                                        {% for error in form.gallery_images.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                        </ul>
                                    {% endif %}
                                     <p class="text-xs text-gray-500 mt-1">Você pode selecionar várias imagens de uma vez para adicionar à galeria.</p>
                                </div>
                            </div>

                            <h4 class="text-md font-medium text-gray-800 mt-6 mb-2">Imagens Atuais da Galeria</h4>
                            {% if content.structure_images %}
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {% for image in content.structure_images %}
                                <div class="relative group">
                                    <img src="{{ url_for('static', filename='uploads/' + image.filename) }}" alt="{{ image.caption or 'Imagem da galeria' }}" class="w-full h-32 object-cover rounded-md">
                                    <div class="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        <form method="POST" action="{{ url_for('dashboard.delete_structure_image', image_id=image.id) }}" onsubmit="return confirm('Tem certeza que deseja excluir esta imagem?');">
                                            <button type="submit" class="text-white bg-red-600 hover:bg-red-700 p-2 rounded-full" title="Excluir Imagem">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-sm text-gray-500">Nenhuma imagem na galeria ainda.</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </fieldset>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="pt-8">
            <button type="submit" class="w-full inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Salvar Alterações
            </button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const sortableList = document.getElementById('sortable-sections');
    const orderInput = document.getElementById('section_order_input');

    if (sortableList) {
        new Sortable(sortableList, {
            animation: 150,
            ghostClass: 'bg-blue-100',
            onEnd: function () {
                const items = sortableList.querySelectorAll('li');
                const newOrder = Array.from(items).map(item => item.dataset.sectionName);
                orderInput.value = newOrder.join(',');
            }
        });
    }
});
</script>
<style>[x-cloak] { display: none !important; }</style>

{% endblock %}