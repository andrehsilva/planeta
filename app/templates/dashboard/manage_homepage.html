{% extends "dashboard/dashboard_base.html" %}
{% from "macros/_form_helpers.html" import render_field %}

{% block dashboard_content %}
<h1 class="text-3xl font-bold text-gray-800 mb-6">{{ title }}</h1>

<div class="bg-white p-4 md:p-8 rounded-lg shadow-md max-w-4xl mx-auto">
    
    {# Dicionário auxiliar para mapear chaves para títulos amigáveis #}
    {% set section_titles = {
        'hero': 'Hero (Topo da Página)',
        'services': 'O que oferecemos',
        'values': 'Por que nos escolher',
        'structure': 'Infraestrutura',
        'videos': 'Nossos Vídeos',
        'blog': 'Diário de bordo (Blog)',
        'cta': 'CTA Final',
        'location': 'Localização'
    } %}

    <div x-data="{ openSection: '' }" class="space-y-4">
        
        <div class="border border-gray-200 rounded-lg">
            <h2 @click="openSection = (openSection === 'order' ? '' : 'order')" class="p-4 font-semibold text-lg cursor-pointer flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors rounded-t-lg">
                <span>Ordem das Seções</span>
                <svg class="h-5 w-5 transition-transform" :class="{ 'rotate-180': openSection === 'order' }" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </h2>
            <div x-show="openSection === 'order'" x-transition class="border-t border-gray-200">
                <form action="{{ url_for('dashboard.update_homepage_order') }}" method="POST">
                    {{ forms.order.hidden_tag() }}
                    <div class="p-4">
                        <input type="hidden" name="section_order" id="section_order_input" value="{{ content.section_order }}">
                        <p class="text-sm text-gray-500 mb-4">Arraste para reordenar as seções na sua página inicial.</p>
                        
                        <ul id="sortable-sections" class="space-y-2">
                            {% for section_key in ordered_sections_admin %}
                            <li data-section-name="{{ section_key }}" class="p-4 bg-white border rounded-md cursor-move flex items-center hover:bg-gray-50">
                                <svg class="h-5 w-5 text-gray-400 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                                <span class="font-medium text-gray-700">{{ section_titles.get(section_key, section_key) }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                            Salvar Ordem
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% for section_key in ordered_sections_admin %}
        {% set form = forms[section_key] %}
        <div class="border border-gray-200 rounded-lg">
            <h2 @click="openSection = (openSection === '{{ section_key }}' ? '' : '{{ section_key }}')" class="p-4 font-semibold text-lg cursor-pointer flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors rounded-t-lg">
                <span>{{ section_titles.get(section_key, section_key) }}</span>
                <svg class="h-5 w-5 transition-transform" :class="{ 'rotate-180': openSection === '{{ section_key }}' }" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </h2>
            <div x-show="openSection === '{{ section_key }}'" x-transition class="border-t border-gray-200">
                <form action="{{ url_for('dashboard.update_' + section_key + '_section') }}" method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    
                    <div class="p-6">
                        {% if section_key == 'videos' %}
                            <fieldset>
                                <div class="bg-slate-100 p-4 rounded-md mb-6 border border-slate-200">
                                    <div class="flex items-center">
                                        {{ form.show_videos_section(class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500") }}
                                        <label for="{{ form.show_videos_section.id }}" class="ml-3 block text-sm font-medium text-gray-900">{{ form.show_videos_section.label.text }}</label>
                                    </div>
                                </div>
                                {{ render_field(form.videos_section_title) }}
                                <div class="mt-8 pt-6 border-t border-gray-200 space-y-8">
                                    <div>
                                        {% if content.videos_section_video1 %}<div class="mb-4 p-4 border rounded-lg bg-gray-50"><p class="block text-sm font-medium text-gray-700 mb-2">Vídeo 1 Atual:</p><video controls class="rounded-lg max-w-full max-h-64 shadow-sm" src="/media/{{ content.videos_section_video1 }}"></video><div class="mt-4 flex items-center">{{ form.remove_videos_section_video1(class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500") }}{{ form.remove_videos_section_video1.label(class="ml-2 text-sm font-medium text-gray-800") }}</div></div>{% endif %}
                                        {{ form.videos_section_video1.label(class="block text-sm font-medium text-gray-700") }}
                                        {{ form.videos_section_video1(class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100") }}
                                    </div>
                                    <div>
                                        {% if content.videos_section_video2 %}<div class="mb-4 p-4 border rounded-lg bg-gray-50"><p class="block text-sm font-medium text-gray-700 mb-2">Vídeo 2 Atual:</p><video controls class="rounded-lg max-w-full max-h-64 shadow-sm" src="/media/{{ content.videos_section_video2 }}"></video><div class="mt-4 flex items-center">{{ form.remove_videos_section_video2(class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500") }}{{ form.remove_videos_section_video2.label(class="ml-2 text-sm font-medium text-gray-800") }}</div></div>{% endif %}
                                        {{ form.videos_section_video2.label(class="block text-sm font-medium text-gray-700") }}
                                        {{ form.videos_section_video2(class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100") }}
                                    </div>
                                    <div>
                                        {% if content.videos_section_video3 %}<div class="mb-4 p-4 border rounded-lg bg-gray-50"><p class="block text-sm font-medium text-gray-700 mb-2">Vídeo 3 Atual:</p><video controls class="rounded-lg max-w-full max-h-64 shadow-sm" src="/media/{{ content.videos_section_video3 }}"></video><div class="mt-4 flex items-center">{{ form.remove_videos_section_video3(class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500") }}{{ form.remove_videos_section_video3.label(class="ml-2 text-sm font-medium text-gray-800") }}</div></div>{% endif %}
                                        {{ form.videos_section_video3.label(class="block text-sm font-medium text-gray-700") }}
                                        {{ form.videos_section_video3(class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100") }}
                                    </div>
                                </div>
                            </fieldset>
                        {% elif section_key == 'structure' %}
                            <fieldset>
                                <div class="bg-slate-100 p-4 rounded-md mb-6 border border-slate-200">
                                    <div class="flex items-center">
                                        {{ form.show_structure_section(class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500") }}
                                        <label for="{{ form.show_structure_section.id }}" class="ml-3 block text-sm font-medium text-gray-900">{{ form.show_structure_section.label.text }}</label>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    {{ render_field(form.structure_section_tagline) }}
                                    {{ render_field(form.structure_section_title) }}
                                    {{ render_field(form.structure_section_subtitle, rows=3) }}
                                    {{ render_field(form.structure_feature1_title) }}
                                    {{ render_field(form.structure_feature1_text, rows=3) }}
                                    {{ render_field(form.structure_feature2_title) }}
                                    {{ render_field(form.structure_feature2_text, rows=3) }}
                                </div>
                                <div class="mt-6 space-y-4">
                                    <div>
                                        {{ form.gallery_images.label(class="block text-sm font-medium text-gray-700") }}
                                        {{ form.gallery_images(class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100", multiple="multiple") }}
                                    </div>
                                </div>
                                <div class="mt-8 pt-6 border-t border-gray-200">
                                    <h4 class="text-md font-medium text-gray-800 mt-6 mb-2">Imagens Atuais da Galeria</h4>
                                    {% if content.structure_images %}
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {% for image in content.structure_images %}
                                        <div class="relative group">
                                            <img src="/media/{{ image.filename }}" alt="{{ image.caption }}" class="w-full h-32 object-cover rounded-md">
                                            <div class="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button type="button" onclick="submitDeleteForm(event, '{{ url_for('dashboard.delete_structure_image', image_id=image.id) }}')" class="text-white bg-red-600 hover:bg-red-700 p-2 rounded-full" title="Excluir Imagem"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <p class="text-sm text-gray-500">Nenhuma imagem na galeria.</p>
                                    {% endif %}
                                </div>
                            </fieldset>
                        {% else %}
                            <fieldset>
                                {% for field in form if field.type == 'BooleanField' and field.name.startswith('show_') %}
                                    <div class="bg-slate-100 p-4 rounded-md mb-6 border border-slate-200">
                                       <div class="flex items-center">
                                            {{ field(class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500") }}
                                            <label for="{{ field.id }}" class="ml-3 block text-sm font-medium text-gray-900">{{ field.label.text }}</label>
                                        </div>
                                    </div>
                                {% endfor %}
                                <div class="space-y-4">
                                    {% for field in form if field.type not in ['CSRFTokenField', 'SubmitField'] and not (field.type == 'BooleanField' and field.name.startswith('show_')) %}
                                        {{ render_field(field, rows=3) }}
                                    {% endfor %}
                                </div>
                            </fieldset>
                        {% endif %}
                    </div>

                    <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                        {% for field in form if field.type == 'SubmitField' %}
                            {{ field(class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700") }}
                        {% endfor %}
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    function submitDeleteForm(event, url) {
        event.preventDefault();
        if (confirm('Tem certeza que deseja excluir esta mídia?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = url;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = document.querySelector('form input[name="csrf_token"]').value;
            form.appendChild(csrfInput);
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const sortableList = document.getElementById('sortable-sections');
        const orderInput = document.getElementById('section_order_input');
        if (sortableList) {
            new Sortable(sortableList, {
                animation: 150,
                ghostClass: 'bg-blue-100',
                onEnd: function () {
                    const newOrder = Array.from(sortableList.querySelectorAll('li')).map(item => item.dataset.sectionName);
                    orderInput.value = newOrder.join(',');
                }
            });
        }
    });
</script>
{% endblock %}
